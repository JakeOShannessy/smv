<?xml version='1.0' encoding='UTF-8'?>
<?define ProductVersion = "1.21.8"?>
<?define ProductUpgradeCode = "1940d8a1-c842-442f-bf5d-00a570219bdb"?>

<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
    <Product Name='Smokeview Lua'
        Id='*'
        UpgradeCode="$(var.ProductUpgradeCode)"
        Language='1033'
        Version='$(var.ProductVersion)'
        Manufacturer='Smokeview'>
        <Package Id='*'
            InstallScope='perUser'
            InstallPrivileges='limited'
            Keywords='Installer'
            Description="Smokeview Lua Installer"
            Comments='A modified smokeview with the ability to run Lua scripts.'
            Manufacturer='Smokeview'
            InstallerVersion='200'
            Languages='1033'
            Platform='x64'
            Compressed='yes' />
        <!-- <Condition Message="You need to be an administrator to install this
        product.">Privileged</Condition> -->
        <Media Id='1' Cabinet='media1.cab' EmbedCab='yes' />
        <Property Id='DiskPrompt' Value="Smokeview Lua Installer" />
        <Upgrade Id="$(var.ProductUpgradeCode)">
            <UpgradeVersion Minimum="$(var.ProductVersion)" OnlyDetect="yes"
                Property="NEWERVERSIONDETECTED" />
            <UpgradeVersion Minimum="0.0.0" Maximum="$(var.ProductVersion)" IncludeMinimum="yes"
                IncludeMaximum="no" Property="OLDERVERSIONBEINGUPGRADED" />
        </Upgrade>
        <Condition Message="A newer version of this software is already installed.">NOT
            NEWERVERSIONDETECTED</Condition>
        <Property Id="ALLUSERS" Secure="yes" Value="2" />
        <Property Id="MSIINSTALLPERUSER" Secure="yes" Value="1" />
        <Icon Id="icon.ico" SourceFile="Build\for_bundle\icon.ico" />
        <Property Id="ARPPRODUCTICON" Value="icon.ico" />
        <Directory Id='TARGETDIR' Name='SourceDir'>
            <Directory Id='AppDataFolder' Name='ConfigFiles'>
                <!-- <Directory Id='FirengConfig' Name='Fireng'> -->
                    <Directory Id='CONFIGDIR' Name='Smokeview Lua'>
                        <Component Id='SMVConfig'
                            Guid='3ca9df6e-ba72-4742-b4ad-58dff4d42b91' Win64="yes">
                            <RegistryValue Root='HKCU' Key='Software\FireEng\SmvLua'
                                Name='InstallFolder'
                                Value='[INSTALLDIR]'
                                Type='string'
                                KeyPath='yes' />
                            <File Name='objects.svo' Source='dist/etc/smokeview/objects.svo' />
                            <File Name='smokeview.ini' Source='dist/etc/smokeview/smokeview.ini' />
                            <!-- <RemoveFolder Id="FirengConfig" On="uninstall" /> -->
                            <RemoveFolder Id="CONFIGDIR" On="uninstall" />
                        </Component>
                    </Directory>
                <!-- </Directory> -->
            </Directory>
            <Directory Id='ProgramFiles64Folder' Name='PFiles'>
                <Directory Id='FirengBin' Name='Fireng'>
                    <Directory Id='INSTALLDIR' Name='Smokeview Lua'>
                        <Component Id='SMVLuaScript' Guid='69f8aba5-7eca-44e8-8319-9fd23d71af9b'
                            Win64="yes">
                            <Environment Id="PATH" Name="PATH" Value="[INSTALLDIR]" Permanent="yes"
                                Part="last" Action="set" System="no" />
                            <File Id='SMVLuaScriptCMD' Name='smvlua.cmd' Source='smvlua.cmd'
                                KeyPath='yes'>
                            </File>
                            <File Id='SMVQScriptCMD' Name='smvq.cmd' Source='smvq.cmd'>
                            </File>
                            <File Name='pthreadVC3.dll' Source='dist/bin/pthreadVC3.dll'> </File>
                            <File Name='json-c.dll' Source='dist/bin/json-c.dll'> </File>
                        </Component>
                        <Directory Id='BINDIR' Name='bin'>
                            <Component Id='SMVQComponent'
                                Guid='c84dc251-0843-4520-95da-1aa889ebd874' Win64="yes">
                                <Environment Id="SMVQ_PATH" Name="SMVQ_PATH"
                                    Value="[BINDIR]\smvq.exe"
                                    Permanent="no" Part="last" Action="set" System="no" />
                                <File Id='SMVQEXE' Name='smvq.exe'
                                    Source='dist/bin/smvq.exe' KeyPath='yes'>
                                </File>
                            </Component>
                            <Component Id='SMVLuaComponent'
                                Guid='767754dc-8fe5-4cbf-920e-6051e321312f' Win64="yes">
                                <Environment Id="SMOKEVIEW_PATH" Name="SMOKEVIEW_PATH"
                                    Value="[BINDIR]\smvlua.exe"
                                    Permanent="no" Part="last" Action="set" System="no" />
                                <File Id='SMVLuaEXE' Name='smvlua.exe'
                                    Source='dist/bin/smokeview.exe' KeyPath='yes'>
                                </File>
                                <File Name='jsonrpc.dll' Source='dist/bin/jsonrpc.dll'> </File>
                                <File Name='glew32.dll' Source='dist/bin/glew32.dll'> </File>
                                <File Name='zlib1.dll' Source='dist/bin/zlib1.dll'> </File>
                                <File Name='libgd.dll' Source='dist/bin/libgd.dll'> </File>
                                <File Name='freeglut.dll' Source='dist/bin/freeglut.dll'> </File>
                                <File Name='jpeg62.dll' Source='dist/bin/jpeg62.dll'> </File>
                                <File Name='glut32.dll' Source='dist/bin/glut32.dll'> </File>
                                <File Name='libpng16.dll' Source='dist/bin/libpng16.dll'>
                                </File>
                                <File Name='getopt.dll' Source='dist/bin/getopt.dll'> </File>

                                <!-- <RegistryValue Root="HKMU"
                                    Key="SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\smvlua.exe"
                                    Value="[!SMVLuaEXE]" Type="string" />
                                <RegistryValue Root="HKMU"
                                    Key="SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\smvlua.exe"
                                    Name="Path" Value="[BINDIR]" Type="string" /> -->

                                <!-- <RegistryValue Root="HKMU" Key="SOFTWARE\Classes\Smv.Document"
                                Name="Smokeview File" Value="!(loc.DescXYZ)" Type="string" /> -->

                                <ProgId Id="Firemodels.Smokeview.1" Description="Smokeview Lua"
                                >
                                    <Extension Id="smv">
                                        <Verb Id="open" Command="open" TargetFile="SMVLuaEXE"
                                            Argument="&quot;%1&quot;" />
                                        <!-- <MIME ContentType="application/smv"
                                            Default="yes" /> -->
                                    </Extension>
                                </ProgId>
                                <!-- <RegistryValue Root="HKMU"
                                    Key="SOFTWARE\smvlua\Capabilities\FileAssociations" Name=".smv"
                                    Value="Smokeview.Document" Type="string" />
                                <RegistryValue Root="HKMU"
                                    Key="SOFTWARE\smvlua\Capabilities\MIMEAssociations"
                                    Name="application/smv" Value="Smokeview.Document" Type="string" />
                                <RegistryValue Root="HKMU"
                                    Key="SOFTWARE\smvlua\Capabilities\shell\Open\command"
                                    Value="&quot;[BINDIR]smvlua.exe&quot; &quot;%1&quot;"
                                    Type="string" /> -->
                                <!-- <RegistryKey Root="HKCR" Key="SmvLua.smv\shell\open\command">
                                    <RegistryValue Type="string"
                                        Value="[INSTALLDIR]bin\smokeview.exe &quot;%1&quot;" />
                                </RegistryKey> -->
                                <!-- <RegistryValue Root="HKCR" Key=".smv" Value="SmvLua.ProgId"
                                    Type="string" /> -->


                                <!-- <RegistryValue Root="HKLM" Key="SOFTWARE\Classes\Smv.Document"
                                    Name="FriendlyTypeName" Value="!(loc.DescXYZ)" Type="string" />
                                <ProgId Id="MyApp.Document" Description="!(loc.DescXYZ)"
                                    Icon="icon.ico" Advertise="yes">
                                    <Extension Id="xyz">
                                        <Verb Id="open" Command="!(loc.ExplorerMenuOpenXYZ)"
                                            Argument="&quot;%1&quot;" />
                                        <MIME Advertise="yes" ContentType="application/xyz"
                                            Default="yes" />
                                    </Extension>
                                </ProgId> -->


                            </Component>
                        </Directory>
                    </Directory>
                </Directory>
            </Directory>
        </Directory>
        <InstallExecuteSequence>
            <RemoveExistingProducts After="InstallValidate" />
        </InstallExecuteSequence>
        <Feature Id='SMVLuaFeature' Level='1'>
            <ComponentRef Id='SMVLuaScript' />
            <ComponentRef Id='SMVLuaComponent' />
            <ComponentRef Id='SMVQComponent' />
            <ComponentRef Id='SMVConfig' />
        </Feature>
    </Product>
</Wix>
